// KQL Queries for PoImageGc Application Insights
// These queries help monitor the application health and user activity

// ============================================
// APPLICATION HEALTH QUERIES
// ============================================

// Application errors in the last 24 hours
// exceptions
// | where timestamp > ago(24h)
// | summarize count() by type, outerMessage
// | order by count_ desc

// Request performance by endpoint
// requests
// | where timestamp > ago(24h)
// | summarize 
//     avgDuration = avg(duration),
//     p95Duration = percentile(duration, 95),
//     count = count()
//   by name
// | order by count desc

// Failed requests
// requests
// | where timestamp > ago(24h)
// | where success == false
// | summarize count() by name, resultCode
// | order by count_ desc

// ============================================
// USER ACTIVITY QUERIES
// ============================================

// Image analysis requests by processing mode
// customEvents
// | where timestamp > ago(24h)
// | where name == "ImageAnalysisRequested"
// | extend processingMode = tostring(customDimensions.ProcessingMode)
// | summarize count() by processingMode
// | render piechart

// Unique users per day
// requests
// | where timestamp > ago(7d)
// | summarize dcount(user_Id) by bin(timestamp, 1d)
// | render timechart

// Most popular image sources (URL vs Base64)
// customEvents
// | where timestamp > ago(7d)
// | where name == "ImageAnalysisRequested"
// | extend imageSource = iff(isnotempty(customDimensions.ImageUrl), "URL", "Base64")
// | summarize count() by imageSource

// ============================================
// DEPENDENCY HEALTH QUERIES
// ============================================

// Azure Computer Vision API performance
// dependencies
// | where timestamp > ago(24h)
// | where type == "HTTP" and target contains "cognitiveservices"
// | summarize 
//     avgDuration = avg(duration),
//     successRate = countif(success == true) * 100.0 / count()
//   by bin(timestamp, 1h)
// | render timechart

// Azure OpenAI API performance
// dependencies
// | where timestamp > ago(24h)
// | where type == "HTTP" and target contains "openai.azure.com"
// | summarize 
//     avgDuration = avg(duration),
//     successRate = countif(success == true) * 100.0 / count()
//   by bin(timestamp, 1h)
// | render timechart

// Dependency failures
// dependencies
// | where timestamp > ago(24h)
// | where success == false
// | summarize count() by target, resultCode
// | order by count_ desc

// ============================================
// PERFORMANCE QUERIES
// ============================================

// Slow requests (>5 seconds)
// requests
// | where timestamp > ago(24h)
// | where duration > 5000
// | project timestamp, name, duration, url
// | order by duration desc
// | take 20

// Memory and CPU trends
// performanceCounters
// | where timestamp > ago(24h)
// | where counter in ("% Processor Time", "Available MBytes")
// | summarize avg(value) by bin(timestamp, 5m), counter
// | render timechart

// ============================================
// CUSTOM METRICS QUERIES
// ============================================

// Image processing time metrics
// customMetrics
// | where timestamp > ago(24h)
// | where name == "ImageProcessingDuration"
// | summarize 
//     avgDuration = avg(value),
//     maxDuration = max(value),
//     minDuration = min(value)
//   by bin(timestamp, 1h)
// | render timechart

// Meme generation success rate
// customMetrics
// | where timestamp > ago(24h)
// | where name == "MemeGenerationAttempts" or name == "MemeGenerationSuccess"
// | summarize sum(value) by name
